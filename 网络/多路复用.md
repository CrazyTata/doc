# 多路复用
## 什么事多路复用
IO多路复用是一种高效处理大量网络连接的技术，它允许多个文件描述符（通常是网络套接字）在一个或多个线程中被监控，以查看它们是否准备好进行读取或写入操作。这种技术在需要同时处理多个网络连接的服务器程序中非常有用，比如Web服务器、数据库服务器等。

### 基本概念

- **文件描述符(File Descriptor)**: 在Unix-like系统中，一切皆文件，文件描述符是一个用于表述打开文件的抽象概念。网络套接字也被视为一种特殊的文件，因此也有对应的文件描述符。

- **阻塞与非阻塞**: 阻塞IO操作意味着当一个线程执行一个IO操作时，该操作会一直等待直到完成。非阻塞IO则允许线程在IO操作未完成时继续执行其他任务。

- **同步与异步**: 同步IO操作意味着IO操作的发起者需要等待操作完成才能继续执行。异步IO操作允许IO操作在后台进行，操作发起者可以继续执行其他任务，直到操作完成时才进行通知。

### IO多路复用技术

IO多路复用技术主要有以下几种实现方式：

1. **select**: select是最早的IO多路复用技术之一，它允许程序监视多个文件描述符，当其中任何一个文件描述符准备好进行读写操作时，select会返回。select的缺点是它能够监视的文件描述符数量有限，并且随着监视的文件描述符数量增加，其性能会下降。

2. **poll**: poll与select类似，但poll没有文件描述符数量的限制，它使用链表来存储文件描述符，因此可以处理更多的并发连接。但poll在处理大量文件描述符时，效率仍然不如后续的epoll和kqueue。

3. **epoll (Linux)**: epoll是Linux特有的IO多路复用机制，它解决了select和poll的性能问题，特别是在处理大量并发连接时。epoll使用一种称为事件通知的机制，只有活跃的文件描述符才会被加入到内核的事件列表中，从而大大减少了内核与用户空间之间的数据交换。

4. **kqueue (BSD)**: kqueue是BSD系统中的IO多路复用机制，与epoll类似，它也使用事件通知机制，允许高效地处理大量并发连接。

### 应用场景

IO多路复用技术广泛应用于需要处理大量并发连接的网络服务器中，如Web服务器、数据库服务器、邮件服务器等。通过使用IO多路复用，可以在有限的线程资源下，有效地处理成千上万的并发连接，大大提高了服务器的性能和效率。

### 总结

IO多路复用技术是现代网络编程中不可或缺的一部分，它通过高效地管理多个并发IO操作，使得服务器能够以较少的资源处理大量的网络连接，是构建高性能网络应用的关键技术之一。

## `epoll`多路复用技术
### 什么是epoll？

`epoll`是一种Linux内核提供的IO多路复用机制，它在处理大量并发连接时表现得非常高效。`epoll`可以看作是`select`和`poll`的改进版，它解决了这两个早期技术在处理大量文件描述符时的性能瓶颈。

### 如何工作？

`epoll`通过以下几个关键特性来实现高效：

1. **事件通知机制**：`epoll`使用一种事件通知机制，只有活跃的文件描述符（即那些有事件发生的文件描述符）才会被通知给应用程序。这意味着，如果没有任何文件描述符准备好进行IO操作，`epoll`不会浪费资源去轮询它们。

2. **内核事件表**：`epoll`维护了一个内核事件表，这个表记录了所有被监视的文件描述符。当这些文件描述符中的任何一个状态发生变化时（例如，有数据可读或可写），内核会更新这个事件表，并通知应用程序。

3. **边缘触发（Edge Triggered, ET）和水平触发（Level Triggered, LT）**：`epoll`支持两种工作模式：
   - **边缘触发模式**：在这种模式下，`epoll`仅在文件描述符状态改变时通知应用程序一次，即使状态仍然保持不变，也不会再次通知。这种方式要求应用程序必须读取或写入所有可用数据，直到没有更多数据可读或写为止。
   - **水平触发模式**：在这种模式下，只要文件描述符处于可读或可写状态，`epoll`就会持续通知应用程序。这类似于`select`和`poll`的行为，但因为`epoll`的高效性，它在处理大量连接时仍然表现良好。

### 为什么epoll高效？

- **减少系统调用**：`epoll`不需要像`select`或`poll`那样，每次调用都传递所有监视的文件描述符。相反，它只需要在初始设置时传递一次，之后仅在文件描述符状态变化时通知应用程序。
  
- **减少上下文切换**：由于`epoll`减少了不必要的系统调用，因此也减少了因系统调用引起的上下文切换，这在处理大量并发连接时尤其重要。

- **按需通知**：`epoll`仅通知活跃的文件描述符，避免了对未活跃文件描述符的无效检查。

### 应用场景

`epoll`特别适合于需要处理大量并发连接的场景，如高性能网络服务器、大规模网络应用等。在这些场景下，`epoll`可以显著提高程序的性能和扩展性。

### 总结

`epoll`是一种高效的IO多路复用技术，它通过事件通知机制和内核事件表来减少不必要的系统调用和上下文切换，从而在处理大量并发连接时表现出色。它支持边缘触发和水平触发两种模式，适用于不同的应用场景和需求。

## 多路复用与`Goroutine`的关系
Go语言的协程（goroutine）本身不是传统意义上的多路复用技术，但它们在运行时系统中是通过多路复用技术来实现高效并发的。

### 协程（goroutine）简介

- **轻量级线程**：Go语言的协程是一种轻量级的线程，由Go运行时（runtime）管理。与操作系统级别的线程相比，创建和切换协程的开销要小得多。

- **并发执行**：你可以启动成千上万个协程来并发执行任务，而不需要担心像传统线程那样消耗过多的系统资源。

### 协程与多路复用的关系

Go运行时使用了操作系统提供的线程（在Linux上通常是内核线程），但这些线程的数量通常远少于协程的数量。Go运行时通过调度器（scheduler）来管理这些协程，决定何时以及在哪个线程上运行哪个协程。这个调度过程在某种程度上类似于多路复用。

- **多路复用**：Go运行时的调度器使用了一种称为“协作式多路复用”（cooperative multitasking）的技术。这意味着协程需要在适当的时候主动让出CPU时间，以便调度器可以切换到其他协程。这与传统的多路复用技术（如epoll或kqueue）不同，后者是由操作系统内核来决定何时唤醒或暂停某个线程。

- **非阻塞操作**：协程在执行IO操作时，如果遇到阻塞（如读写文件或网络请求），它们会自动让出控制权给调度器，调度器可以继续运行其他协程，直到IO操作完成。这使得IO操作不会阻塞其他协程的执行，从而实现了高效的并发。

### 总结

虽然Go语言的协程不是传统意义上的多路复用技术，但它们在Go运行时的调度下，实现了类似多路复用的效果，允许大量并发执行的协程高效地共享有限的线程资源。这种设计使得Go语言非常适合于需要处理大量并发任务的应用程序，如网络服务器、数据处理等。